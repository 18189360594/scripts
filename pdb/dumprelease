#!/bin/sh
set -e

release=$1
tree=$2
architecture=$3
tag=release_`echo $release | sed 's/\./_/g'`

echo "Updating from CVS..."
if [ ! -d fink ]; then
  cvs -z3 -d:pserver:anonymous@fink.cvs.sourceforge.net:/cvsroot/fink co -d fink dists
fi
cd fink
cvs -z3 -q update -r $tag
cd ..

rm -f fink/dists var/db/fink.db
ln -s $tree fink/dists

# As of 0.6.3 / 0.7.0.. you need to specify the tree you want 'stable' to be. 
# That is, './dumprelease 0.6.3 10.2-gcc3.3' and './dumprelease 0.7.0 10.3'
# This may be temporary till we find a better solution.

# As of 0.8.1, you also need to specify the architecture (either i386
# or powerpc), and the output filename will contain the architecture string.  
# That is, './dumprelease 0.8.1 10.4 i386' will produce 
# $release-$architecture-stable.sql
echo "Dumping $tree/stable to $release-$architecture-stable.sql..."
./dump --distribution=$tree --tree=stable --release=$release-stable --architecture=$architecture >$release-$architecture-stable.sql
if [ -f var/db/fink.db ]; then
 rm var/db/fink.db
fi

exit 0
