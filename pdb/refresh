#!/bin/sh
set -e

# allow user to pass dist(s) on command-line
if [ $# -gt 0 ]; then
  dists=($@)
else
  dists=(10.2-gcc3.3 10.3 10.4-transitional)
fi

echo "Updating from CVS..."
if [ -d fink ]; then
  cd fink
  cvs -z3 -q update -Al
  cvs -z3 -q update -Ad ${dists[@]}
  cd ..
else
  cvs -z3 -d:pserver:anonymous@fink.cvs.sourceforge.net:/cvsroot/fink co -d fink dists
fi

# flush the previous dump
echo -n "" > current.sql

# Dump each supported source tree of the dists
for dist in ${dists[@]}; do
    rm -f fink/dists var/db/fink.db
    ln -s $dist fink/dists

    for tree in stable unstable; do
	echo ""
	if [ $dist = "10.4" ]; then
	    for arch in powerpc i386; do
		echo "Dumping $dist/$tree $arch..."
		./dump --distribution=$dist --tree=$tree --architecture=$arch --release=current-$dist-$tree-$arch >> current.sql
	    done
	else
	    echo "Dumping $dist/$tree..."
	    ./dump --distribution=$dist --tree=$tree --release=current-$dist-$tree >> current.sql
	fi
    done
done

echo ""

exit 0
